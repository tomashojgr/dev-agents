#!/usr/bin/env php
<?php

declare(strict_types=1);

(function () { $dir = __DIR__; while (!file_exists($dir . '/vendor/autoload.php')) { $parent = dirname($dir); if ($parent === $dir) { fwrite(STDERR, "autoload.php not found\n"); exit(1); } $dir = $parent; } require $dir . '/vendor/autoload.php'; })();

use DevAgents\TaskLoader;

// â”€â”€ Arguments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

$taskId = $argv[1] ?? '';

if ($taskId === '') {
    echo "Usage: da-commit <task-id>\n";
    echo "Example: da-commit task-001-dkim-validation\n";
    exit(1);
}

// â”€â”€ Load task â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

$task = TaskLoader::load($taskId);

// â”€â”€ Git checks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

exec('git rev-parse --git-dir 2>/dev/null', $out, $code);
if ($code !== 0) {
    echo "âŒ Not a git repository\n";
    exit(1);
}

$diffLines = [];
exec('git diff --staged', $diffLines);
$diff = implode("\n", $diffLines);
if (trim($diff) === '') {
    echo "âŒ No staged changes. Use 'git add' first.\n";
    exit(1);
}

$changedFilesLines = [];
exec('git diff --staged --name-only', $changedFilesLines);
$changedFiles = trim(implode("\n", $changedFilesLines));

echo "ğŸ“‹ Staged files:\n$changedFiles\n\n";

// â”€â”€ Validate scope â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if (!empty($task['scope'])) {
    $scopeFiles = $task['scope'];
    $staged = explode("\n", $changedFiles);
    $outOfScope = array_filter($staged, function (string $file) use ($scopeFiles): bool {
        foreach ($scopeFiles as $allowed) {
            if (str_starts_with($file, $allowed)) {
                return false;
            }
        }
        return true;
    });

    if (!empty($outOfScope)) {
        echo "âš ï¸  Files outside task scope:\n";
        foreach ($outOfScope as $file) {
            echo "   $file\n";
        }
        echo "\nProceed anyway? [y/N] ";
        $answer = strtolower(trim(fgets(STDIN)));
        if ($answer !== 'y') {
            echo "âŒ Aborted\n";
            exit(1);
        }
    }
}

// â”€â”€ Build prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

$prompt = <<<PROMPT
Generate git commit message(s) following Conventional Commits standard.

Task: {$task['goal']}

Format: <type>(<scope>): <description>
Types: feat, fix, chore, docs, refactor, test, style, perf, ci
- scope optional but recommended
- imperative mood, lowercase, no period, max 72 chars

Rules:
- If diff contains multiple logical changes, output MULTIPLE lines
- Each message prefixed with "COMMIT: "
- Output ONLY the COMMIT: lines, nothing else

Changed files:
$changedFiles

Diff:
$diff
PROMPT;

// â”€â”€ Call AI CLI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

use DevAgents\Config;
$config = new Config();
$responseLines = [];
exec($config->aiPrint($prompt) . ' 2>/dev/null', $responseLines);
$response = implode("\n", $responseLines);

if (empty($response)) {
    echo "âŒ No response from claude CLI\n";
    exit(1);
}

// â”€â”€ Parse commits â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

$commits = [];
foreach (explode("\n", trim($response)) as $line) {
    if (str_starts_with($line, 'COMMIT: ')) {
        $commits[] = substr($line, 8);
    }
}

if (count($commits) === 0) {
    echo "âŒ No commit messages generated\n";
    echo $response . "\n";
    exit(1);
}

// â”€â”€ Validate format â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

$pattern = '/^(feat|fix|chore|docs|refactor|test|style|perf|ci)(\(.+\))?: .{3,}/';

foreach ($commits as $msg) {
    if (!preg_match($pattern, $msg)) {
        echo "âŒ Invalid format: $msg\n";
        exit(1);
    }
}

// â”€â”€ Confirm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

$count = count($commits);
echo "ğŸ’¬ Generated $count commit(s):\n";
foreach ($commits as $i => $msg) {
    echo "  " . ($i + 1) . ". $msg\n";
}
echo "\nProceed? [Y/n] ";
$answer = strtolower(trim(fgets(STDIN)));

if ($answer === 'n') {
    echo "âŒ Aborted\n";
    exit(1);
}

// â”€â”€ Commit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

$first = array_shift($commits);
passthru('git commit -m ' . escapeshellarg($first));

foreach ($commits as $msg) {
    echo "\nğŸ“ Next commit (stage relevant files, then run):\n";
    echo "   git commit -m " . escapeshellarg($msg) . "\n";
}

echo "\nâœ… Done\n";
