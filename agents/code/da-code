#!/usr/bin/env php
<?php

declare(strict_types=1);

require __DIR__ . '/../../vendor/autoload.php';

use DevAgents\TaskLoader;

// â”€â”€ Arguments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

$taskId = $argv[1] ?? '';

if ($taskId === '') {
    echo "Usage: da-code <task-id>\n";
    echo "Example: da-code task-001-dkim-validation\n";
    exit(1);
}

// â”€â”€ Load task â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

$task = TaskLoader::load($taskId);

// â”€â”€ Check approval â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if ($task['status'] !== 'approved') {
    echo "âŒ Task is not approved (status: {$task['status']})\n";
    echo "   Run: make approve TASK={$taskId}\n";
    exit(1);
}

// â”€â”€ Check git state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

exec('git rev-parse --git-dir 2>/dev/null', $out, $code);
if ($code !== 0) {
    echo "âŒ Not a git repository\n";
    exit(1);
}

$dirty = trim(shell_exec('git status --porcelain'));
if ($dirty !== '') {
    echo "âš ï¸  Working tree has uncommitted changes:\n";
    echo shell_exec('git status --short') . "\n";
    echo "Proceed anyway? [y/N] ";
    $answer = strtolower(trim(fgets(STDIN)));
    if ($answer !== 'y') {
        echo "âŒ Aborted. Commit or stash changes first.\n";
        exit(1);
    }
}

// â”€â”€ Build system prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

$taskFile = getcwd() . '/.tasks/' . $taskId . '/TASK.md';
$taskContents = file_get_contents($taskFile);

$claudeMdContext = '';
if (file_exists(getcwd() . '/CLAUDE.md')) {
    $claudeMdContext = file_get_contents(getcwd() . '/CLAUDE.md');
}

$systemPrompt = <<<PROMPT
You are an expert PHP developer implementing a well-defined task.

{$claudeMdContext}

Implement the following task exactly as specified. Follow the acceptance criteria. Stay within the defined scope. Do not make changes outside the scope.

When done:
1. Run any tests if a test suite exists
2. Stage only files within the task scope with git add
3. Report what was implemented

TASK SPECIFICATION:
{$taskContents}
PROMPT;

// â”€â”€ Launch claude Code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

echo "ğŸš€ Starting Claude Code for task: {$taskId}\n";
echo "   Goal: {$task['goal']}\n\n";

$escaped = escapeshellarg($systemPrompt);

// claude (Claude Code CLI) runs interactively
passthru("claude \"$systemPrompt\"", $exitCode);

if ($exitCode !== 0) {
    echo "\nâŒ Claude Code exited with code $exitCode\n";
    exit($exitCode);
}

// â”€â”€ Mark task as done â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

$contents = file_get_contents($taskFile);
$updated = preg_replace('/^status:\s*.+$/m', 'status: done', $contents);
file_put_contents($taskFile, $updated);

echo "\nâœ… Task marked as done: {$taskId}\n";
echo "\nNext steps:\n";
echo "  git add <files>\n";
echo "  make commit TASK={$taskId}\n";
