#!/usr/bin/env php
<?php

declare(strict_types=1);

(function () { $dir = __DIR__; while (!file_exists($dir . '/vendor/autoload.php')) { $parent = dirname($dir); if ($parent === $dir) { fwrite(STDERR, "autoload.php not found\n"); exit(1); } $dir = $parent; } require $dir . '/vendor/autoload.php'; })();

use DevAgents\Config;

$config = new Config();
$cwd = getcwd();

// ── Arguments ─────────────────────────────────────────────────────────────────

$savePromptFile = null;
foreach ($argv as $i => $arg) {
    if ($arg === '--save-prompt' && isset($argv[$i + 1])) {
        $savePromptFile = $argv[$i + 1];
    }
}

// ── Resolve tools ─────────────────────────────────────────────────────────────

$tools = $config->lintTools();

if ($tools === null) {
    // Auto-detect – use project config files if present, else our defaults
    $tools = [];

    if (file_exists("$cwd/vendor/bin/phpstan")) {
        $tools[] = ['name' => 'PHPStan', 'cmd' => "vendor/bin/phpstan analyse --no-progress"];
    } elseif (exec('which phpstan 2>/dev/null')) {
        $tools[] = ['name' => 'PHPStan', 'cmd' => "phpstan analyse --no-progress"];
    }

    if (file_exists("$cwd/vendor/bin/phpcs")) {
        $tools[] = ['name' => 'PHP_CodeSniffer', 'cmd' => "vendor/bin/phpcs"];
    } elseif (exec('which phpcs 2>/dev/null')) {
        $tools[] = ['name' => 'PHP_CodeSniffer', 'cmd' => "phpcs"];
    }

    if (file_exists("$cwd/vendor/bin/php-cs-fixer")) {
        $tools[] = ['name' => 'PHP CS Fixer', 'cmd' => 'vendor/bin/php-cs-fixer fix --dry-run --diff'];
    } elseif (exec('which php-cs-fixer 2>/dev/null')) {
        $tools[] = ['name' => 'PHP CS Fixer', 'cmd' => 'php-cs-fixer fix --dry-run --diff'];
    }

    if (file_exists("$cwd/vendor/bin/psalm")) {
        $tools[] = ['name' => 'Psalm', 'cmd' => 'vendor/bin/psalm'];
    } elseif (exec('which psalm 2>/dev/null')) {
        $tools[] = ['name' => 'Psalm', 'cmd' => 'psalm'];
    }
}

// ── Fallback: PHP syntax check ────────────────────────────────────────────────

if (empty($tools)) {
    echo "ℹ️  No linters found or configured. Running PHP syntax check.\n\n";
    exec("find " . escapeshellarg("$cwd/src") . " -name '*.php' 2>/dev/null", $phpFilesArr);
    $phpFiles = implode("\n", $phpFilesArr);
    $files = array_filter(explode("\n", trim($phpFiles)));
    $errors = 0;
    foreach ($files as $file) {
        exec(PHP_BINARY . " -l " . escapeshellarg($file) . " 2>&1", $output, $code);
        if ($code !== 0) {
            echo "❌ " . implode("\n", $output) . "\n";
            $errors++;
        }
    }
    if ($errors === 0) {
        echo "✅ PHP syntax OK (" . count($files) . " files)\n";
    }
    exit($errors > 0 ? 1 : 0);
}

// ── Run each linter ───────────────────────────────────────────────────────────

$outputs = [];

foreach ($tools as $tool) {
    echo "▶ Running {$tool['name']}...\n";

    $output = [];
    $code = 0;
    exec("cd " . escapeshellarg($cwd) . " && {$tool['cmd']} 2>&1", $output, $code);

    $outputStr = implode("\n", $output);
    $outputs[$tool['name']] = ['output' => $outputStr, 'code' => $code];

    if ($code !== 0) {
        echo "❌ {$tool['name']} failed\n";
        echo "\n" . $outputStr . "\n\n";
    } else {
        echo "✅ {$tool['name']} passed\n";
    }
}

// ── Handle failures ───────────────────────────────────────────────────────────

$failedOutputs = array_filter($outputs, fn($r) => $r['code'] !== 0);

if (empty($failedOutputs)) {
    echo "\n✅ All linters passed\n";
    exit(0);
}

if ($savePromptFile !== null) {
    // Run phpcbf first if available — fixes style issues automatically
    $phpcbfCmd = null;
    if (file_exists("$cwd/vendor/bin/phpcbf")) {
        $phpcbfCmd = "vendor/bin/phpcbf";
    } elseif (exec('which phpcbf 2>/dev/null')) {
        $phpcbfCmd = "phpcbf";
    }

    if ($phpcbfCmd !== null) {
        echo "\n▶ Running phpcbf (auto-fix style issues)...\n";
        exec("cd " . escapeshellarg($cwd) . " && {$phpcbfCmd} 2>&1", $cbfOutput, $cbfCode);
        echo implode("\n", $cbfOutput) . "\n";

        // Re-run linters to see what remains after phpcbf
        echo "\n▶ Re-running linters after phpcbf...\n";
        $failedOutputs = [];
        foreach ($tools as $tool) {
            $output = [];
            $code = 0;
            exec("cd " . escapeshellarg($cwd) . " && {$tool['cmd']} 2>&1", $output, $code);
            if ($code !== 0) {
                echo "❌ {$tool['name']} still failing\n";
                $failedOutputs[$tool['name']] = ['output' => implode("\n", $output), 'code' => $code];
            } else {
                echo "✅ {$tool['name']} passed\n";
            }
        }

        // Commit phpcbf changes if anything was modified
        $diffLines = [];
        exec('git diff --name-only 2>/dev/null', $diffLines);
        if (!empty(array_filter($diffLines))) {
            exec('git add -A 2>&1', $addOut, $addCode);
            exec('git commit -m ' . escapeshellarg('style: auto-fix via phpcbf') . ' 2>&1', $commitOut, $commitCode);
            if ($commitCode === 0) {
                echo "✅ phpcbf changes committed\n";
            }
        }

        if (empty($failedOutputs)) {
            echo "\n✅ All linters passed after phpcbf\n";
            exit(0);
        }
    }

    // Save prompt to file for the caller (e.g. Makefile) to pass to AI
    $issueText = '';
    foreach ($failedOutputs as $name => $result) {
        $issueText .= "=== $name ===\n{$result['output']}\n\n";
    }

    $prompt = <<<PROMPT
You are an expert PHP developer. The following linters reported errors in this project.

Fix all reported issues. Stay within the affected files — do not refactor unrelated code.

When done:
1. Run the linters again to verify all issues are resolved
2. Report a summary of what was changed

LINT OUTPUT:
{$issueText}
PROMPT;

    file_put_contents($savePromptFile, $prompt);
    echo "\nℹ️  Prompt saved to {$savePromptFile}\n";
}

echo "\n❌ Lint failed\n";
exit(1);
