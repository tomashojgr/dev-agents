#!/usr/bin/env php
<?php

declare(strict_types=1);

(function () { $dir = __DIR__; while (!file_exists($dir . '/vendor/autoload.php')) { $parent = dirname($dir); if ($parent === $dir) { fwrite(STDERR, "autoload.php not found\n"); exit(1); } $dir = $parent; } require $dir . '/vendor/autoload.php'; })();

use DevAgents\Config;

$config = new Config();

// â”€â”€ Git checks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

exec('git rev-parse --git-dir 2>/dev/null', $out, $code);
if ($code !== 0) {
    echo "âŒ Not a git repository\n";
    exit(1);
}

$dirty = trim(shell_exec('git status --porcelain'));
if ($dirty !== '') {
    echo "âŒ Working tree has uncommitted changes. Commit everything before releasing.\n";
    echo shell_exec('git status --short');
    exit(1);
}

// â”€â”€ Determine current version â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

$latestTag = trim(shell_exec('git tag --sort=-v:refname | grep -E "^v[0-9]+\.[0-9]+\.[0-9]+" | head -1 2>/dev/null'));
$currentVersion = $latestTag !== '' ? ltrim($latestTag, 'v') : '0.0.0';

echo "Current version: v{$currentVersion}\n";

// â”€â”€ Get commits since last tag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

$logRange = $latestTag !== '' ? "{$latestTag}..HEAD" : 'HEAD';
$log = trim(shell_exec("git log {$logRange} --oneline 2>/dev/null"));

if ($log === '') {
    echo "âŒ No commits since last release (v{$currentVersion})\n";
    exit(1);
}

echo "\nCommits since v{$currentVersion}:\n";
foreach (explode("\n", $log) as $line) {
    echo "  $line\n";
}

// â”€â”€ Determine bump type via AI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

echo "\nğŸ¤– Analyzing commits for version bump...\n";

$prompt = <<<PROMPT
Analyze these git commits and determine the appropriate semantic version bump (major/minor/patch) following semver.org rules:
- major: breaking changes (BREAKING CHANGE in footer, or ! after type)
- minor: new features (feat:)
- patch: bug fixes, chores, docs (fix:, chore:, docs:, etc.)

Commits:
{$log}

Respond with EXACTLY one line in this format:
BUMP: <major|minor|patch>
REASON: <one sentence explanation>
CHANGELOG:
- <bullet point per logical change, max 10>
PROMPT;

$response = shell_exec($config->aiPrint($prompt) . ' 2>/dev/null');

if (empty(trim($response))) {
    echo "âŒ No response from claude CLI\n";
    exit(1);
}

// â”€â”€ Parse AI response â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

$bump = 'patch';
$reason = '';
$changelog = [];

foreach (explode("\n", $response) as $line) {
    if (str_starts_with($line, 'BUMP: ')) {
        $bump = strtolower(trim(substr($line, 6)));
        if (!in_array($bump, ['major', 'minor', 'patch'])) {
            $bump = 'patch';
        }
    } elseif (str_starts_with($line, 'REASON: ')) {
        $reason = trim(substr($line, 8));
    } elseif (str_starts_with($line, '- ')) {
        $changelog[] = trim($line);
    }
}

// â”€â”€ Calculate next version â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[$major, $minor, $patch] = array_map('intval', explode('.', $currentVersion));

match ($bump) {
    'major' => [$major++, $minor = 0, $patch = 0],
    'minor' => [$minor++, $patch = 0],
    default => $patch++,
};

$nextVersion = "v{$major}.{$minor}.{$patch}";

// â”€â”€ Confirm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

echo "\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";
echo "Bump type:    {$bump}\n";
echo "Reason:       {$reason}\n";
echo "New version:  {$nextVersion}\n";

if (!empty($changelog)) {
    echo "\nChangelog:\n";
    foreach ($changelog as $entry) {
        echo "  $entry\n";
    }
}

echo "\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";
echo "Create release {$nextVersion}? [Y/n] ";
$answer = strtolower(trim(fgets(STDIN)));

if ($answer === 'n') {
    echo "âŒ Release cancelled\n";
    exit(1);
}

// â”€â”€ Tag release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

$changelogText = implode("\n", $changelog);
$tagMessage = "Release {$nextVersion}\n\n{$changelogText}";

passthru('git tag -a ' . escapeshellarg($nextVersion) . ' -m ' . escapeshellarg($tagMessage), $exitCode);

if ($exitCode !== 0) {
    echo "âŒ Failed to create tag\n";
    exit(1);
}

echo "\nâœ… Tagged release {$nextVersion}\n";
echo "\nTo push the release:\n";
echo "  git push origin {$nextVersion}\n";
