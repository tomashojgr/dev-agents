#!/usr/bin/env php
<?php

declare(strict_types=1);

(function () { $dir = __DIR__; while (!file_exists($dir . '/vendor/autoload.php')) { $parent = dirname($dir); if ($parent === $dir) { fwrite(STDERR, "autoload.php not found\n"); exit(1); } $dir = $parent; } require $dir . '/vendor/autoload.php'; })();

use DevAgents\Config;

$config = new Config();
$cwd = getcwd();

// ‚îÄ‚îÄ Resolve tools ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

$tools = $config->lintTools();

if ($tools === null) {
    $tools = [];

    if (file_exists("$cwd/vendor/bin/phpstan")) {
        $tools[] = ['name' => 'PHPStan', 'cmd' => "vendor/bin/phpstan analyse --no-progress"];
    } elseif (trim((string) shell_exec('which phpstan 2>/dev/null'))) {
        $tools[] = ['name' => 'PHPStan', 'cmd' => "phpstan analyse --no-progress"];
    }

    if (file_exists("$cwd/vendor/bin/phpcs")) {
        $tools[] = ['name' => 'PHP_CodeSniffer', 'cmd' => "vendor/bin/phpcs"];
    } elseif (trim((string) shell_exec('which phpcs 2>/dev/null'))) {
        $tools[] = ['name' => 'PHP_CodeSniffer', 'cmd' => "phpcs"];
    }

    if (file_exists("$cwd/vendor/bin/php-cs-fixer")) {
        $tools[] = ['name' => 'PHP CS Fixer', 'cmd' => 'vendor/bin/php-cs-fixer fix --dry-run --diff'];
    } elseif (trim((string) shell_exec('which php-cs-fixer 2>/dev/null'))) {
        $tools[] = ['name' => 'PHP CS Fixer', 'cmd' => 'php-cs-fixer fix --dry-run --diff'];
    }

    if (file_exists("$cwd/vendor/bin/psalm")) {
        $tools[] = ['name' => 'Psalm', 'cmd' => 'vendor/bin/psalm'];
    } elseif (trim((string) shell_exec('which psalm 2>/dev/null'))) {
        $tools[] = ['name' => 'Psalm', 'cmd' => 'psalm'];
    }
}

if (empty($tools)) {
    echo "‚ùå No linters found or configured. Nothing to fix.\n";
    exit(1);
}

// ‚îÄ‚îÄ Run linters and collect failures ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

echo "‚ñ∂ Running linters...\n\n";

$failedOutputs = [];

foreach ($tools as $tool) {
    $output = [];
    $code = 0;
    exec("cd " . escapeshellarg($cwd) . " && {$tool['cmd']} 2>&1", $output, $code);

    $outputStr = implode("\n", $output);

    if ($code !== 0) {
        echo "‚ùå {$tool['name']} failed\n";
        $failedOutputs[$tool['name']] = $outputStr;
    } else {
        echo "‚úÖ {$tool['name']} passed\n";
    }
}

if (empty($failedOutputs)) {
    echo "\n‚úÖ All linters passed ‚Äî nothing to fix.\n";
    exit(0);
}

// ‚îÄ‚îÄ Build prompt for Claude Code ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

$issueText = '';
foreach ($failedOutputs as $name => $output) {
    $issueText .= "=== $name ===\n$output\n\n";
}

$claudeMdContext = '';
if (file_exists($cwd . '/CLAUDE.md')) {
    $claudeMdContext = "\n" . file_get_contents($cwd . '/CLAUDE.md') . "\n";
}

$prompt = <<<PROMPT
You are an expert PHP developer. The following linters reported errors in this project.
{$claudeMdContext}
Fix all reported issues. Stay within the affected files ‚Äî do not refactor unrelated code.

When done:
1. Run the linters again to verify all issues are resolved
2. Report a summary of what was changed

LINT OUTPUT:
{$issueText}
PROMPT;

// ‚îÄ‚îÄ Launch Claude Code interactively ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

echo "\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n";
echo "ü§ñ Launching Claude Code to fix lint issues...\n\n";

passthru($config->aiInteractive($prompt), $exitCode);

if ($exitCode !== 0) {
    echo "\n‚ùå Claude Code exited with code $exitCode\n";
    exit($exitCode);
}

echo "\n‚úÖ Done. Run make lint to verify.\n";
